<div class="profile-page" *ngIf="user; else loginPrompt">
  <mat-card class="profile-card">
    <div class="card-header">
      <div>
        <h1>Meu perfil</h1>
        <p *ngIf="!isEditing">Visualize seus dados cadastrados. Clique em "Editar perfil" para alterar nome, sobrenome, data ou senha.</p>
        <p *ngIf="isEditing">Atualize seus dados pessoais. Email e CPF permanecem inalterados.</p>
      </div>
      <div class="header-actions" *ngIf="userDetails && !loadingProfile">
        <button *ngIf="!isEditing" mat-stroked-button color="primary" type="button" (click)="startEdit()">
          Editar perfil
        </button>
        <button *ngIf="isEditing" mat-stroked-button color="primary" type="button" (click)="cancelEdit()" [disabled]="loading">
          Cancelar
        </button>
        <a mat-stroked-button color="primary" routerLink="/meus-pedidos">Meus pedidos</a>
      </div>
    </div>

    <ng-container *ngIf="!loadingProfile; else loadingBlock">
      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="profile-form">
        <div class="section">
          <div class="section-header">
            <h3>Dados pessoais</h3>
            <p>Nome, sobrenome, data de nascimento e senha.</p>
          </div>
          <div class="grid">
            <mat-form-field appearance="outline">
              <mat-label>Nome</mat-label>
              <input matInput formControlName="nome" />
              <mat-error *ngIf="form.get('nome')?.invalid">Obrigatorio</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Sobrenome</mat-label>
              <input matInput formControlName="sobrenome" />
              <mat-error *ngIf="form.get('sobrenome')?.invalid">Obrigatorio</mat-error>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="email" [disabled]="true" />
          </mat-form-field>

          <div class="grid">
            <mat-form-field appearance="outline">
              <mat-label>CPF</mat-label>
              <input matInput formControlName="cpf" [disabled]="true" appCpfMask />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Data de nascimento</mat-label>
              <input matInput type="date" formControlName="dataNascimento" [max]="maxDate" />
              <mat-error *ngIf="form.get('dataNascimento')?.hasError('required')">Obrigatorio</mat-error>
              <mat-error *ngIf="form.get('dataNascimento')?.hasError('minAge')">Necessario ter 18 anos ou mais</mat-error>
            </mat-form-field>
          </div>

          <div class="grid">
            <mat-form-field appearance="outline">
              <mat-label>Nova senha (opcional)</mat-label>
              <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="senha" placeholder="Deixe em branco para manter" />
              <button mat-icon-button matSuffix type="button" (click)="hidePassword = !hidePassword" [attr.aria-label]="'Esconder senha'">
                <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
              </button>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Confirmar nova senha</mat-label>
              <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmarSenha" placeholder="Repita a senha" />
              <button mat-icon-button matSuffix type="button" (click)="hideConfirmPassword = !hideConfirmPassword" [attr.aria-label]="'Esconder confirmação de senha'">
                <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
              </button>
            </mat-form-field>
          </div>

          <div class="section-actions">
            <button mat-flat-button color="primary" type="submit" [disabled]="loading || !isEditing">
              {{ loading ? 'Salvando dados...' : 'Salvar dados pessoais' }}
            </button>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h3>Telefone</h3>
            <p>Cadastre ou altere o número para contato.</p>
          </div>
          <div class="grid" [formGroup]="telefoneForm">
            <mat-form-field appearance="outline">
              <mat-label>Código de área (DDD)</mat-label>
              <input matInput formControlName="codigoArea" maxlength="2" />
              <mat-hint>2 dígitos</mat-hint>
              <mat-error *ngIf="telefoneForm.get('codigoArea')?.hasError('pattern')">Use apenas 2 números.</mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Número</mat-label>
              <input matInput formControlName="numero" maxlength="9" />
              <mat-hint>Formato: 9XXXXXXXX</mat-hint>
              <mat-error *ngIf="telefoneForm.get('numero')?.hasError('pattern')">Número deve ter 9 dígitos e começar com 9.</mat-error>
            </mat-form-field>
          </div>
          <div class="section-actions">
            <button mat-flat-button color="primary" type="button" (click)="saveTelefone()" [disabled]="!isEditing || savingTelefone">
              {{ savingTelefone ? 'Salvando telefone...' : 'Salvar telefone' }}
            </button>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h3>Endereço</h3>
            <p>Inclua o endereço principal para entregas.</p>
          </div>
          <div class="grid" [formGroup]="enderecoForm">
            <mat-form-field appearance="outline">
              <mat-label>Logradouro</mat-label>
              <input matInput formControlName="logradouro" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Numero</mat-label>
              <input matInput formControlName="numero" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Complemento</mat-label>
              <input matInput formControlName="complemento" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Bairro</mat-label>
              <input matInput formControlName="bairro" />
            </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>CEP</mat-label>
            <input matInput formControlName="cep" maxlength="8" />
            <mat-hint>Apenas números</mat-hint>
            <mat-error *ngIf="enderecoForm.get('cep')?.hasError('pattern')">CEP deve ter 8 dígitos.</mat-error>
          </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Estado</mat-label>
              <mat-select formControlName="estadoId" (selectionChange)="onEstadoChange($event.value)">
                <mat-option [value]="null">Selecione</mat-option>
                <mat-option *ngFor="let estado of estados" [value]="estado.id">{{ estado.sigla }} - {{ estado.nome }}</mat-option>
              </mat-select>
              <mat-error *ngIf="enderecoForm.get('estadoId')?.invalid">Selecione um estado.</mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Cidade</mat-label>
              <mat-select
                formControlName="cidadeId"
                [disabled]="!estadoSelecionado || !cidadesFiltradas.length"
                (selectionChange)="onCidadeChange($event.value)">
                <mat-option [value]="null">Selecione</mat-option>
                <mat-option *ngFor="let cidade of cidadesFiltradas" [value]="cidade.id">
                  {{ cidade.nome }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="estadoSelecionado">Mostrando cidades de {{ estadoSelecionado.sigla }}</mat-hint>
              <mat-error *ngIf="enderecoForm.get('cidadeId')?.invalid">Selecione uma cidade.</mat-error>
            </mat-form-field>
          </div>

          <div class="section-actions">
            <button mat-flat-button color="primary" type="button" (click)="saveEndereco()" [disabled]="!isEditing || savingEndereco">
              {{ savingEndereco ? 'Salvando endereço...' : 'Salvar endereço' }}
            </button>
          </div>
        </div>

        <div class="button-group">
          <button mat-stroked-button color="warn" type="button" (click)="logout()">
            Sair da conta
          </button>
        </div>

        <p *ngIf="!isEditing" class="hint">Para editar, clique em "Editar perfil" acima.</p>
        <p *ngIf="message" class="success">{{ message }}</p>
        <p *ngIf="error" class="error">{{ error }}</p>
      </form>
    </ng-container>
  </mat-card>
</div>

<ng-template #loadingBlock>
  <div class="loading">Carregando dados do perfil...</div>
</ng-template>

<ng-template #loginPrompt>
  <div class="profile-page">
    <mat-card class="profile-card">
      <h2>Entre para editar seu cadastro</h2>
      <p>Use sua conta para atualizar suas informacoes.</p>
      <div class="prompt-actions">
        <a mat-flat-button color="primary" routerLink="/login">Entrar</a>
        <a mat-stroked-button color="primary" routerLink="/registro">Criar conta</a>
      </div>
    </mat-card>
  </div>
</ng-template>
