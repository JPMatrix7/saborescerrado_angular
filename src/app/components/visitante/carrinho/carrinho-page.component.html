<div class="carrinho-page">
  <div class="container">
    <div class="page-header">
      <div class="header-content">
        <span class="badge-chip">üõí Carrinho</span>
        <h1>Finalize sua compra</h1>
        <p class="subtitle">Revise seus itens e complete o pedido</p>
      </div>
    </div>

    <div class="carrinho-content" *ngIf="items().length; else emptyCart">
      <div class="items-section">
        <div class="section-header">
          <h2>Itens no carrinho</h2>
          <span class="item-count">{{ items().length }} {{ items().length === 1 ? 'item' : 'itens' }}</span>
        </div>
        
        <div class="cart-items-list">
          <div class="cart-item" *ngFor="let item of items()">
            <div class="item-image">
              <div class="product-badge">üç∑</div>
            </div>
            
            <div class="item-info">
              <h3 class="item-name">{{ item.licor.nome }}</h3>
              <p class="item-price">{{ formatCurrency(item.precoUnitario ?? item.licor.preco) }}<span class="price-label"> / unidade</span></p>
              
              <div class="quantity-control">
                <button type="button" class="qty-btn" (click)="updateQty(item, item.quantidade - 1)" [disabled]="item.quantidade <= 1">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
                <span class="qty-value">{{ item.quantidade }}</span>
                <button type="button" class="qty-btn" (click)="updateQty(item, item.quantidade + 1)">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
            </div>
            
            <div class="item-actions">
              <div class="item-subtotal">
                <span class="subtotal-label">Subtotal</span>
                <span class="subtotal-value">{{ formatCurrency((item.precoUnitario || item.licor.preco || 0) * item.quantidade) }}</span>
              </div>
              <button type="button" class="btn-remove" (click)="remove(item)" title="Remover item">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="summary-section">
        <div class="summary-card">
          <h2 class="summary-title">Resumo do Pedido</h2>

          <div class="loading-indicator" *ngIf="isLoadingDados()">
            <div class="spinner"></div>
            <p>Carregando seus dados...</p>
          </div>

          <div class="form-section">
            <div class="form-group">
              <label class="form-label">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8.707 1.5a1 1 0 00-1.414 0L.646 8.146a.5.5 0 00.708.708L2 8.207V13.5A1.5 1.5 0 003.5 15h9a1.5 1.5 0 001.5-1.5V8.207l.646.647a.5.5 0 00.708-.708L13 5.793V2.5a.5.5 0 00-.5-.5h-1a.5.5 0 00-.5.5v1.293L8.707 1.5z"/>
                </svg>
                Endere√ßo de entrega
              </label>
              <div class="select-wrapper">
                <select class="form-select" [(ngModel)]="selectedEnderecoId" [disabled]="isLoadingDados()">
                  <option [ngValue]="null" disabled>Selecione um endere√ßo</option>
                  <option *ngFor="let end of enderecos()" [ngValue]="end.id">
                    {{ end.logradouro }}, {{ end.numero }} - {{ end.bairro }}
                  </option>
                </select>
                <svg class="select-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M4.427 6.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 6H4.604a.25.25 0 00-.177.427z"/>
                </svg>
              </div>
              <p class="help-text" *ngIf="!enderecos().length && !isLoadingDados()">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
                  <path fill-rule="evenodd" d="M7 14A7 7 0 107 0a7 7 0 000 14zM6.5 4a.5.5 0 01.5.5v4a.5.5 0 01-1 0v-4a.5.5 0 01.5-.5zm.5 7a.75.75 0 10-1.5 0 .75.75 0 001.5 0z"/>
                </svg>
                Nenhum endere√ßo cadastrado. <a routerLink="/perfil">Adicionar agora</a>
              </p>
            </div>

            <div class="form-group">
              <label class="form-label">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M3.654 1.328a.678.678 0 00-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 004.168 6.608 17.569 17.569 0 006.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 00-.063-1.015l-2.307-1.794a.678.678 0 00-.58-.122l-2.19.547a1.745 1.745 0 01-1.657-.459L5.482 8.062a1.745 1.745 0 01-.46-1.657l.548-2.19a.678.678 0 00-.122-.58L3.654 1.328z"/>
                </svg>
                Telefone de contato
              </label>
              <div class="select-wrapper">
                <select class="form-select" [(ngModel)]="selectedTelefoneId" [disabled]="isLoadingDados()">
                  <option [ngValue]="null" disabled>Selecione um telefone</option>
                  <option *ngFor="let tel of telefones()" [ngValue]="tel.id">
                    ({{ tel.codigoArea || tel.ddd }}) {{ tel.numero }}
                  </option>
                </select>
                <svg class="select-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M4.427 6.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 6H4.604a.25.25 0 00-.177.427z"/>
                </svg>
              </div>
              <p class="help-text" *ngIf="!telefones().length && !isLoadingDados()">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
                  <path fill-rule="evenodd" d="M7 14A7 7 0 107 0a7 7 0 000 14zM6.5 4a.5.5 0 01.5.5v4a.5.5 0 01-1 0v-4a.5.5 0 01.5-.5zm.5 7a.75.75 0 10-1.5 0 .75.75 0 001.5 0z"/>
                </svg>
                Nenhum telefone cadastrado. <a routerLink="/perfil">Adicionar agora</a>
              </p>
            </div>
          </div>
          
          <div class="summary-details">
            <div class="summary-row">
              <span>Subtotal</span>
              <span class="value">{{ formatCurrency(total()) }}</span>
            </div>
            
            <div class="summary-row">
              <span>Frete</span>
              <span class="value free">Gr√°tis</span>
            </div>
            
            <div class="summary-divider"></div>
            
            <div class="summary-row total">
              <span>Total</span>
              <span class="value">{{ formatCurrency(total()) }}</span>
            </div>
          </div>

          <div class="payment-section">
            <label class="form-label">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M0 4a2 2 0 012-2h12a2 2 0 012 2v1H0V4zm0 3v5a2 2 0 002 2h12a2 2 0 002-2V7H0zm3 2h1a1 1 0 011 1v1a1 1 0 01-1 1H3a1 1 0 01-1-1v-1a1 1 0 011-1z"/>
              </svg>
              Forma de pagamento
            </label>
            <div class="select-wrapper">
              <select class="form-select" [(ngModel)]="pagamento" (change)="onPaymentChange()">
                <option [ngValue]="FormaPagamento.CARTAO">Cart√£o de Cr√©dito</option>
                <option [ngValue]="FormaPagamento.PIX">PIX</option>
                <option [ngValue]="FormaPagamento.BOLETO">Boleto Banc√°rio</option>
              </select>
              <svg class="select-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M4.427 6.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 6H4.604a.25.25 0 00-.177.427z"/>
              </svg>
            </div>

            <div class="payment-details" *ngIf="pagamento === FormaPagamento.PIX">
              <div class="form-group">
                <label class="form-label">Chave PIX</label>
                <input type="text" class="form-input" [(ngModel)]="chavePix" (input)="checkoutError=''" placeholder="Digite sua chave PIX" />
              </div>
            </div>

            <div class="payment-details" *ngIf="pagamento === FormaPagamento.BOLETO">
              <div class="form-group">
                <label class="form-label">Linha digit√°vel</label>
                <input type="text" class="form-input" [(ngModel)]="linhaDigitavelBoleto" (input)="checkoutError=''" placeholder="00000.00000 00000.000000 00000.000000 0 00000000000000" />
              </div>
            </div>

            <div class="payment-details" *ngIf="pagamento === FormaPagamento.CARTAO">
              <div class="form-group">
                <label class="form-label">√öltimos d√≠gitos do cart√£o</label>
                <input type="text" class="form-input" [(ngModel)]="ultimosDigitosCartao" maxlength="8" (input)="checkoutError=''" placeholder="1234" />
              </div>
              <div class="form-group">
                <label class="form-label">Nome do titular <span class="optional">(opcional)</span></label>
                <input type="text" class="form-input" [(ngModel)]="nomeTitularCartao" (input)="checkoutError=''" placeholder="Nome impresso no cart√£o" />
              </div>
              <div class="form-group">
                <label class="form-label">Bandeira <span class="optional">(opcional)</span></label>
                <input type="text" class="form-input" [(ngModel)]="bandeiraCartao" (input)="checkoutError=''" placeholder="Visa, Mastercard..." />
              </div>
            </div>
          </div>

          <div class="action-buttons">
            <button 
              type="button" 
              class="btn-checkout" 
              (click)="checkout()" 
              [disabled]="isCheckoutLoading"
            >
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" *ngIf="!isCheckoutLoading">
                <path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732l-3.354 1.935-1.18 4.455a1 1 0 01-1.933 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732l3.354-1.935 1.18-4.455A1 1 0 0112 2z" clip-rule="evenodd"/>
              </svg>
              <div class="spinner" *ngIf="isCheckoutLoading"></div>
              {{ isCheckoutLoading ? 'Processando...' : 'Finalizar Compra' }}
            </button>

            <button 
              type="button" 
              class="btn-continue" 
              (click)="continueShopping()"
            >
              Continuar Comprando
            </button>
          </div>

          <div class="message success-message" *ngIf="checkoutMessage">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            {{ checkoutMessage }}
          </div>
          <div class="message error-message" *ngIf="checkoutError">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            {{ checkoutError }}
          </div>
        </div>
      </div>
    </div>

    <ng-template #emptyCart>
      <div class="empty-cart">
        <div class="empty-icon">
          <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
            <circle cx="60" cy="60" r="60" fill="#f3f4f6"/>
            <path d="M40 45h40l-4 30H44l-4-30z" stroke="#9ca3af" stroke-width="3" fill="none"/>
            <circle cx="48" cy="82" r="4" fill="#9ca3af"/>
            <circle cx="72" cy="82" r="4" fill="#9ca3af"/>
            <path d="M35 35h10l4 10" stroke="#9ca3af" stroke-width="3" stroke-linecap="round"/>
          </svg>
        </div>
        <h2>Seu carrinho est√° vazio</h2>
        <p>Adicione produtos e comece suas compras!</p>
        <button type="button" class="btn-shop" (click)="continueShopping()">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
          </svg>
          Ver Produtos
        </button>
      </div>
    </ng-template>
  </div>
</div>
