<mat-card>
  <mat-card-header>
    <mat-card-title>
      <div style="display: flex; align-items: center; gap: 10px;">
        <button mat-icon-button (click)="voltar()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <span>{{ isEditMode ? 'Editar Produto' : 'Novo Produto' }}</span>
      </div>
    </mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="produtoForm" (ngSubmit)="onSubmit()">
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Nome</mat-label>
          <input matInput formControlName="nome" required>
          <mat-error *ngIf="produtoForm.get('nome')?.hasError('required')">
            Nome é obrigatório
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Tipo de Licor</mat-label>
          <mat-select formControlName="tipo" required>
            <mat-option *ngFor="let tipo of tiposLicor" [value]="tipo">
              {{ tipo }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Categoria</mat-label>
          <mat-select formControlName="categoriaId" required>
            <mat-option *ngFor="let categoria of categorias()" [value]="categoria.id">
              {{ categoria.nome }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Fornecedor</mat-label>
          <mat-select formControlName="fornecedorId" required>
            <mat-option *ngFor="let fornecedor of fornecedores()" [value]="fornecedor.id">
              {{ fornecedor.nomeFantasia || fornecedor.razaoSocial }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Descrição</mat-label>
        <textarea matInput formControlName="descricao" rows="3"></textarea>
      </mat-form-field>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Preço (R$)</mat-label>
          <input matInput type="number" formControlName="preco" required>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Estoque</mat-label>
          <input matInput type="number" formControlName="estoque" required>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Teor Alcoólico (%)</mat-label>
          <input matInput type="number" formControlName="teorAlcoolico" required>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Sabor</mat-label>
          <mat-select formControlName="saborId">
            <mat-option [value]="null">Nenhum</mat-option>
            <mat-option *ngFor="let sabor of sabores()" [value]="sabor.id">
              {{ sabor.nome }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Embalagem</mat-label>
          <mat-select formControlName="embalagemId">
            <mat-option [value]="null">Nenhuma</mat-option>
            <mat-option *ngFor="let embalagem of embalagens()" [value]="embalagem.id">
              {{ embalagem.volume }}ml - {{ embalagem.material }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Safra</mat-label>
          <mat-select formControlName="safraId">
            <mat-option [value]="null">Nenhuma</mat-option>
            <mat-option *ngFor="let safra of safras()" [value]="safra.id">
              {{ safra.anoSafra }} - {{ safra.fazenda }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Imagem principal (URL retornada do upload)</mat-label>
          <input matInput formControlName="imagem" required>
          <mat-hint>Envie em /upload/imagem e cole a URL (ex: /uploads/abc.jpg)</mat-hint>
          <mat-error *ngIf="produtoForm.get('imagem')?.invalid">Obrigatorio enviar a imagem principal.</mat-error>
        </mat-form-field>
      </div>

      <div class="form-row upload-row">
        <div>
          <p class="helper">Upload direto para /upload/imagem (requer token ADMIN)</p>
          <input type="file" (change)="onFileSelected($event)" accept="image/*" />
          <p *ngIf="isUploading">Enviando imagem...</p>
        </div>
        <div class="image-preview" *ngIf="imagemPreview">
          <p>Preview</p>
          <img [src]="imagemPreview" alt="Imagem principal" />
        </div>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Galeria (URLs separadas por vírgula)</mat-label>
        <textarea matInput formControlName="imagens" rows="2"></textarea>
        <mat-hint>Inclua URLs adicionais se quiser galeria. A principal será adicionada automaticamente.</mat-hint>
      </mat-form-field>

      <div class="form-actions">
        <button mat-raised-button type="button" (click)="onCancel()">Cancelar</button>
        <button mat-raised-button color="primary" type="submit" [disabled]="!produtoForm.valid">
          Salvar
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
