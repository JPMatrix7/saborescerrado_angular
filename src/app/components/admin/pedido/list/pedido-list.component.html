<mat-card>
  <mat-card-header>
    <mat-card-title>
      <div style="display: flex; align-items: center; gap: 10px;">
        <button mat-icon-button (click)="voltar()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <span>Pedidos</span>
      </div>
    </mat-card-title>
    <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
      <label>
        Filtro status
        <select [(ngModel)]="statusFiltro">
          <option [ngValue]="'todos'">Todos</option>
          <option *ngFor="let st of statusOptions" [ngValue]="st">{{ st }}</option>
        </select>
      </label>
      <button mat-stroked-button color="primary" (click)="loadPedidos()">Recarregar</button>
    </div>
  </mat-card-header>
  
  <mat-card-content>
    <div *ngIf="loading()" class="no-pedidos">
      <mat-icon>hourglass_empty</mat-icon>
      <p>Carregando pedidos...</p>
    </div>

    <div *ngIf="!loading() && error()" class="no-pedidos">
      <mat-icon>error</mat-icon>
      <p>{{ error() }}</p>
    </div>

    <div class="pedidos-container">
      <mat-expansion-panel *ngFor="let pedido of pedidosFiltrados()" class="pedido-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <div class="panel-title-content">
              <span class="pedido-id">Pedido #{{ pedido.id }}</span>
              <mat-chip [color]="getStatusColor(pedido.status)" highlighted>
                {{ getStatusLabel(pedido.status) }}
              </mat-chip>
            </div>
          </mat-panel-title>
          <mat-panel-description>
            <div class="panel-description-content">
              <span>{{ pedido.dataCompra | date: 'dd/MM/yyyy' }}</span>
              <span class="valor-total">R$ {{ pedido.valorTotal.toFixed(2) }}</span>
            </div>
          </mat-panel-description>
        </mat-expansion-panel-header>

        <div class="pedido-details">
          <div class="info-section">
            <h4>Informações do Pedido</h4>
            <div class="info-grid">
              <div class="info-item">
                <strong>Data da Compra:</strong>
                <span>{{ pedido.dataCompra | date: 'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <div class="info-item">
                <strong>Forma de Pagamento:</strong>
                <span>{{ getFormaPagamentoLabel(pedido.formaPagamento) }}</span>
              </div>
              <div class="info-item">
                <strong>Situação Pagamento:</strong>
                <span>
                  <mat-chip [color]="pedido.pago ? '' : 'warn'" highlighted>
                    {{ pedido.pago ? 'Pago' : 'Pendente' }}
                  </mat-chip>
                </span>
              </div>
            </div>
          </div>

          <div class="itens-section">
            <h4>Itens do Pedido</h4>
            <table mat-table [dataSource]="pedido.itens" class="itens-table">
              
              <ng-container matColumnDef="produto">
                <th mat-header-cell *matHeaderCellDef>Produto</th>
                <td mat-cell *matCellDef="let item">{{ item.licor?.nome || ('Produto #' + item.licorId) }}</td>
              </ng-container>

              <ng-container matColumnDef="quantidade">
                <th mat-header-cell *matHeaderCellDef>Quantidade</th>
                <td mat-cell *matCellDef="let item">{{ item.quantidade }}</td>
              </ng-container>

              <ng-container matColumnDef="precoUnitario">
                <th mat-header-cell *matHeaderCellDef>Preço Unit.</th>
                <td mat-cell *matCellDef="let item">R$ {{ (item.precoUnitario ?? 0).toFixed(2) }}</td>
              </ng-container>

              <ng-container matColumnDef="subtotal">
                <th mat-header-cell *matHeaderCellDef>Subtotal</th>
                <td mat-cell *matCellDef="let item">R$ {{ (item.subtotal ?? 0).toFixed(2) }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['produto', 'quantidade', 'precoUnitario', 'subtotal']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['produto', 'quantidade', 'precoUnitario', 'subtotal'];"></tr>
            </table>

            <div class="total-section">
              <strong>Valor Total:</strong>
              <span class="total-value">R$ {{ pedido.valorTotal.toFixed(2) }}</span>
            </div>
          </div>

          <div class="actions-section">
            <div class="admin-control">
              <h4>Status</h4>
              <select [(ngModel)]="statusForm[pedido.id!]">
                <option *ngFor="let st of statusOptions" [ngValue]="st">{{ st }}</option>
              </select>
              <button mat-raised-button color="primary" (click)="salvarStatus(pedido)">
                <mat-icon>sync</mat-icon>
                Atualizar status
              </button>
            </div>

            <button 
              mat-raised-button 
              color="warn" 
              (click)="cancelarPedido(pedido.id!)">
              <mat-icon>cancel</mat-icon>
              Cancelar Pedido
            </button>
            <button mat-raised-button color="primary" (click)="verDetalhes(pedido)">
              <mat-icon>visibility</mat-icon>
              Ver Mais Detalhes
            </button>
          </div>
        </div>
      </mat-expansion-panel>
    </div>

    <div *ngIf="!loading() && !error() && pedidosFiltrados().length === 0" class="no-pedidos">
      <mat-icon>shopping_cart</mat-icon>
      <p>Nenhum pedido encontrado</p>
    </div>
  </mat-card-content>
</mat-card>
